<head>
  <title></title>
  <style>
    iframe.main {
      position:absolute;
      left:0;
      top:0;
      bottom:0;
      right:0;
      height:100%;
      width:50%;
      border:0;
    }
    iframe.preview {
      position:absolute;
      left:50%;
      top:0;
      bottom:0;
      right:0;
      height:100%;
      width:50%;
      border:0;
    }
  </style>
  <script>
    var req_element = {};

    function preview_request(request_url) {
      var req = new XMLHttpRequest();
      req.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          var data = JSON.parse(this.responseText);
          preview_append(data["mimetype"], data["url"]);
        }
      };
      req.open("GET", request_url, true);
      req.send();
    }

    function preview_append(mimetype, url) {
      var win = window.frames["preview-frame"];
      var doc = win.document;
      var container = doc.createElement("div");
      var label = doc.createElement("div");
      var filename = doc.createElement("span");
      filename.classList.add("filename");
      filename.appendChild(doc.createTextNode(url));
      var type = doc.createElement("span");
      type.classList.add("filetype");
      type.appendChild(doc.createTextNode("type: " + mimetype));
      label.appendChild(filename);
      label.appendChild(type);
      label.classList.add("label");
      var content = doc.createElement("div");
      if (mimetype.startsWith("image/")) {
        var img = doc.createElement("img");
        img.src = url + "?" + String((new Date).getTime());
        img.addEventListener("load", function () { win.scrollTo(0, doc.body.scrollHeight); });
        content.appendChild(img);
      }
      else {
        // nothing to load. immediately scroll
        win.setTimeout(function () { win.scrollTo(0, doc.body.scrollHeight); }, 0);
      }
      content.classList.add("content");
      container.appendChild(label);
      container.appendChild(content);
      container.classList.add("container");
      label.style.cursor = "not-allowed";
      label.addEventListener("click", function () { del_container(url); });
      del_container(url);
      add_container(url, container);
    }

    function add_container(id, container) {
      req_element[id] = container;
      window.frames["preview-frame"].document.body.append(container);
    }

    function del_container(id) {
      if (id in req_element) {
        window.frames["preview-frame"].document.body.removeChild(req_element[id]);
        delete req_element[id];
      }
    }

    document.addEventListener("DOMContentLoaded", function() {
      var doc = window.frames["preview-frame"].document; 
      var link  = doc.createElement('link');
      link.rel  = 'stylesheet';
      link.type = 'text/css';
      link.href = '/preview/static/css/preview.css';
      doc.head.appendChild(link);
    });
  </script>
</head>
<body>
  <iframe class="main" name="main-frame" src="/{{path}}"></iframe>
  <iframe class="preview" id="preview-frame" name="preview-frame"></iframe>
</body>
